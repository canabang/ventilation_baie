# =================================================================================================
# üìÇ CONFIGURATION DE BASE ESPHOME (Partag√©e entre tous les projets ESP32)
# =================================================================================================
# Ce fichier contient la configuration commune pour tous vos modules ESP32 sous ESPHome.
# Il inclut : WiFi, API, OTA, capteurs syst√®me (uptime, signal WiFi, temp√©rature interne, etc.)
#
# MODE D'EMPLOI :
# 1. Copiez ce fichier `.base.yaml` dans votre dossier ESPHome.
# 2. Cr√©ez un fichier `secrets.yaml` avec vos identifiants WiFi (voir exemple ci-dessous).
# 3. Dans vos projets, incluez ce fichier via `packages: base: !include .base.yaml`.
# 4. D√©finissez les substitutions n√©cessaires dans votre fichier principal (name, board, IP, etc.).
# =================================================================================================

# -------------------------------------------------------------------------------------------------
# ‚öôÔ∏è EXEMPLE DE SUBSTITUTIONS √Ä D√âFINIR DANS VOTRE FICHIER PRINCIPAL
# -------------------------------------------------------------------------------------------------
# D√©commentez et adaptez ces lignes dans votre projet (ex: ventilation_v2.yaml) :
#
# substitutions:
#   name: "mon-esp32"                  # Nom unique du module
#   board: esp32-s3-devkitc-1          # Type de carte ESP32
#   type: esp-idf                      # Framework (esp-idf ou arduino)
#   loglevel: INFO                     # Niveau de log (DEBUG, INFO, WARN, ERROR)
#   static_ip: 192.168.1.100           # Adresse IP fixe du module
#
# packages:
#   base: !include .base.yaml          # Inclusion de ce fichier
# -------------------------------------------------------------------------------------------------

# -------------------------------------------------------------------------------------------------
# üîê FICHIER secrets.yaml (√† cr√©er dans le m√™me dossier)
# -------------------------------------------------------------------------------------------------
# Cr√©ez un fichier `secrets.yaml` avec le contenu suivant (remplacez par vos vraies valeurs) :
#
# wifi_ssid: "MonReseauWiFi"
# wifi_password: "MotDePasseSuperSecret"
# hotspot_password: "FallbackHotspot123"  # Mot de passe du point d'acc√®s de secours
# -------------------------------------------------------------------------------------------------

# =================================================================================================
# CONFIGURATION ESPHOME
# =================================================================================================
esphome:
  name: ${name}
  friendly_name: ${name}

esp32:
  board: ${board}
  framework:
    type: ${type}

# =================================================================================================
# JOURNALISATION (LOGS)
# =================================================================================================
logger:
  level: ${loglevel}

# =================================================================================================
# MISE √Ä JOUR OTA (Over-The-Air)
# =================================================================================================
# Permet de mettre √† jour le firmware via WiFi sans c√¢ble USB
ota:
  - platform: esphome
    id: ota_esphome

# =================================================================================================
# CONFIGURATION R√âSEAU WiFi
# =================================================================================================
wifi:
  # Identifiants WiFi (stock√©s dans secrets.yaml pour la s√©curit√©)
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: true  # Connexion plus rapide en m√©morisant le dernier canal WiFi
  
  # Configuration IP Statique (recommand√©e pour les devices domotiques)
  manual_ip:
    static_ip: ${static_ip}         # ‚ö†Ô∏è √Ä d√©finir dans votre fichier principal (ex: 192.168.1.100)
    gateway: 192.168.1.1            # ‚ö†Ô∏è Adaptez √† votre routeur (souvent .1 ou .254)
    subnet: 255.255.255.0           # Masque r√©seau standard pour les r√©seaux domestiques
    dns1: 192.168.1.1               # ‚ö†Ô∏è DNS primaire (souvent identique √† la gateway)
    dns2: 8.8.8.8                   # DNS secondaire (Google DNS comme backup)
  
  # Point d'acc√®s de secours (Fallback Hotspot)
  # Si la connexion WiFi √©choue, l'ESP32 cr√©e un hotspot pour configuration
  ap:
    ssid: "Hotspot ${name}"
    password: !secret hotspot_password

# Portail captif (interface web de configuration en mode hotspot)
captive_portal:

# =================================================================================================
# SERVEUR WEB INT√âGR√â
# =================================================================================================
# Interface web accessible sur http://<IP_ESP32>
web_server:
  port: 80
  version: 3
  local: true
  include_internal: true

# =================================================================================================
# SYNCHRONISATION HORAIRE (Home Assistant)
# =================================================================================================
time:
  - platform: homeassistant
    id: homeassistant_time
    timezone: Europe/Paris  # ‚ö†Ô∏è Adaptez √† votre fuseau horaire
    on_time_sync:
      then:
        - logger.log: "Synchronized system clock"

# =================================================================================================
# CAPTEURS TEXTE / INFORMATIONS SYST√àME
# =================================================================================================
text_sensor:
  # Informations r√©seau WiFi
  - platform: wifi_info
    ip_address:
      name: "@ip"
      icon: mdi:ip-network
      id: ip_addr
    ssid:
      name: "SSID"
      icon: mdi:wifi
      id: connected_ssid
    bssid:
      name: "BSSID"
      icon: mdi:router-wireless
      id: connected_bssid
    mac_address:
      name: "@mac"
      icon: mdi:ethernet
      id: device_mac
  
  # Version ESPHome
  - platform: version
    name: "Version"
    icon: mdi:chip
  
  # Heure format√©e (depuis Home Assistant)
  - platform: template
    name: "HA time"
    icon: mdi:clock-outline
    lambda: |-
      char str[17];
      time_t currTime = id(homeassistant_time).now().timestamp;
      strftime(str, sizeof(str), "%H:%M %d-%m-%Y", localtime(&currTime));
      return  { str };
    update_interval: 30s
    entity_category: "diagnostic"
  
  # Uptime format√© (Dur√©e depuis le dernier red√©marrage)
  - platform: uptime
    name: "Uptime"
    icon: mdi:clock-fast
    update_interval: 15s
    format:
      days: " j "
      hours: " h "
      minutes: " mn "
      seconds: " s"

# =================================================================================================
# CAPTEURS BINAIRES (ON/OFF)
# =================================================================================================
binary_sensor:
  # Statut de connexion √† Home Assistant
  - platform: status
    name: "status"
    icon: mdi:check-network-outline

# =================================================================================================
# CAPTEURS NUM√âRIQUES (Diagnostic syst√®me)
# =================================================================================================
sensor:
  # Temp√©rature interne de la puce ESP32
  - platform: internal_temperature
    name: "Interntemp"
    id: interntemp
    icon: mdi:thermometer
    update_interval: 30s
  
  # Signal WiFi (en dBm, valeur brute)
  - platform: wifi_signal
    name: "Wifi signal db"
    icon: mdi:wifi-strength-4
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"
  
  # Signal WiFi (converti en pourcentage pour lisibilit√©)
  - platform: copy
    source_id: wifi_signal_db
    name: "Wifi signal %"
    id: wifi_percent
    icon: mdi:signal
    filters:
      - lambda: return min(max(2 * (x + 100.0), 0.0), 100.0);
    unit_of_measurement: "%"
    entity_category: "diagnostic"
    device_class: ""

# =================================================================================================
# BOUTONS (Actions manuelles)
# =================================================================================================
button:
  # Red√©marrage simple du module
  - platform: restart
    name: "Restart"
    icon: mdi:restart
  
  # R√©initialisation compl√®te (efface toutes les configurations stock√©es)
  - platform: factory_reset
    name: "Factory reset"
    id: "factory_reset_button"
    icon: mdi:factory

# =================================================================================================
# MODE DEBUG (optionnel, d√©commenter si besoin de diagnostic pouss√©)
# =================================================================================================
debug:
  update_interval: 5s

# -------------------------------------------------------------------------------------------------
# üìù NOTES IMPORTANTES :
# -------------------------------------------------------------------------------------------------
# 1. **Secrets**       : Ne commitez JAMAIS le fichier `secrets.yaml` dans git !
#                        Ajoutez `secrets.yaml` dans votre `.gitignore`.
#
# 2. **IP Statique**   : Assurez-vous que l'IP choisie est en dehors de la plage DHCP
#                        de votre routeur pour √©viter les conflits.
#
# 3. **Gateway/DNS**   : Les valeurs 192.168.1.1 sont des exemples. Adaptez-les √†
#                        votre r√©seau (souvent .1, .254, ou .2 selon votre box).
#
# 4. **S√©curit√©**      : Ce fichier est con√ßu pour √™tre partag√© publiquement.
#                        Toutes les donn√©es sensibles DOIVENT √™tre dans secrets.yaml.
# -------------------------------------------------------------------------------------------------