esphome:
  name: esp-fan
  friendly_name: esp-fan

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "GXuwx9Eh7Jr9+Ftj90jDXDfkYIWw9fQ77Si5HCQ94m8="

ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Esp-Fan Fallback Hotspot"
    password: !secret wifi_password

captive_portal:

# Interface web optionnelle
web_server:
  port: 80

# --- LOGIQUE DE CONTR√îLE ---
script:
  - id: apply_fan_curve
    then:
      - lambda: |-
          if (!id(auto_mode).state) return;
          if (id(boost_mode).state) return; // Priorit√© au mode Boost
          
          float temp = id(temp_ambient).state;
          if (std::isnan(temp)) return; // S√©curit√© si pas encore de lecture

          float t_min = id(temp_min).state;
          float t_max = id(temp_max).state;
          int new_speed = 0;

          if (temp < t_min) {
            new_speed = 0;
          } else if (temp >= t_max) {
            new_speed = 100;
          } else {
            new_speed = (int)(((temp - t_min) / (t_max - t_min)) * 100);
          }

          if (new_speed == 0) {
            if (id(arctic_fan).state) id(arctic_fan).turn_off().perform();
          } else {
            id(arctic_fan).turn_on().set_speed(new_speed).perform();
          }

# Sortie PWM pour contr√¥ler la vitesse
output:
  - platform: ledc
    pin: GPIO6
    id: fan_pwm_output
    frequency: 25000 Hz  # Fr√©quence PWM optimale pour Arctic P12 Pro (21-28 kHz)
    min_power: 0.0
    max_power: 1.0
    # D√©commentez la ligne suivante si vous utilisez un transistor NPN (signal invers√©)
    # inverted: true

# Capteur de vitesse (tachym√®tre)
sensor:
  - platform: pulse_counter
    pin: 
      number: GPIO4
      mode:
        input: true
        pullup: true
    name: "Vitesse Ventilateur"
    unit_of_measurement: 'RPM'
    accuracy_decimals: 0
    filters:
      # Le pulse_counter compte en pulses/min
      # Les ventilateurs 4 fils font 2 impulsions par tour
      # RPM = pulses/min / 2
      - lambda: return x / 2.0;
    count_mode:
      rising_edge: INCREMENT
      falling_edge: DISABLE
    update_interval: 3s
    id: fan_speed
  
  # Capteur de temp√©rature interne ESP32
  - platform: internal_temperature
    name: "Temp√©rature ESP32"
    update_interval: 60s
    id: esp32_temp

  # Capteur DHT22 pour temp√©rature
  - platform: dht
    id: dht_sensor
    pin: GPIO7
    model: DHT22
    temperature:
      name: "Temp√©rature Ambiante"
      id: temp_ambient
      on_value:
        then:
          - script.execute: apply_fan_curve
    update_interval: 30s

  # Capteur de vitesse en % pour l'affichage
  - platform: template
    name: "Puissance Ventilateur"
    unit_of_measurement: "%"
    icon: "mdi:percent"
    accuracy_decimals: 0
    lambda: |-
      if (id(arctic_fan).state) {
        return id(arctic_fan).speed;
      } else {
        return 0;
      }
    update_interval: 10s

# Ventilateur
fan:
  - platform: speed
    output: fan_pwm_output
    name: "Ventilateur Arctic Pro"
    id: arctic_fan
    speed_count: 100

# Contr√¥les et R√©glages
number:
  # Slider pour contr√¥le manuel
  - platform: template
    name: "Vitesse Manuelle"
    id: manual_speed
    min_value: 0
    max_value: 100
    step: 5
    unit_of_measurement: "%"
    mode: slider
    icon: "mdi:fan"
    set_action:
      then:
        - lambda: |-
            id(auto_mode).turn_off();
            id(boost_mode).turn_off(); // √âteint le boost si on touche au manuel
            ESP_LOGI("manual", "Vitesse manuelle demand√©e: %.0f%% - D√©sactivation Modes Auto/Boost", x);
        - if:
            condition:
              lambda: 'return int(x) == 0;'
            then:
              - fan.turn_off: arctic_fan
            else:
              - fan.turn_on:
                  id: arctic_fan
                  speed: !lambda 'return int(x);'
    lambda: "return id(arctic_fan).state ? id(arctic_fan).speed : 0;"

  # R√©glage dynamique de la temp√©rature MIN
  - platform: template
    name: "Consigne Temp Min"
    id: temp_min
    min_value: 15
    max_value: 35
    step: 1
    unit_of_measurement: "¬∞C"
    mode: box
    icon: "mdi:thermometer-low"
    optimistic: true
    restore_value: true
    initial_value: 25
    set_action:
      then:
        - lambda: 'id(temp_min).publish_state(x);' # N√©cessaire car on surcharge set_action
        - script.execute: apply_fan_curve

  # R√©glage dynamique de la temp√©rature MAX
  - platform: template
    name: "Consigne Temp Max"
    id: temp_max
    min_value: 25
    max_value: 50
    step: 1
    unit_of_measurement: "¬∞C"
    mode: box
    icon: "mdi:thermometer-high"
    optimistic: true
    restore_value: true
    initial_value: 35
    set_action:
      then:
        - lambda: 'id(temp_max).publish_state(x);' # N√©cessaire car on surcharge
        - script.execute: apply_fan_curve

  # R√©glage de la dur√©e du Boost (en minutes)
  - platform: template
    name: "Dur√©e Boost"
    id: boost_duration
    min_value: 1
    max_value: 60
    step: 1
    unit_of_measurement: "min"
    mode: box
    icon: "mdi:timer-outline"
    optimistic: true
    restore_value: true
    initial_value: 10

# Switchs
switch:
  # Contr√¥le automatique
  - platform: template
    name: "Mode Automatique"
    id: auto_mode
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    icon: "mdi:thermostat-auto"
    turn_on_action:
      - logger.log: "Mode automatique activ√©"
      - script.execute: apply_fan_curve
    turn_off_action:
      - logger.log: "Mode automatique d√©sactiv√©"

  # MODE BOOST (100% pendant X minutes)
  - platform: template
    name: "Mode Boost"
    id: boost_mode
    optimistic: true
    icon: "mdi:rocket-launch"
    turn_on_action:
      - logger.log: "üöÄ BOOST ACTIF !"
      - fan.turn_on:
          id: arctic_fan
          speed: 100
      - delay: !lambda 'return id(boost_duration).state * 60000;'
      - switch.turn_off: boost_mode
    turn_off_action:
      - logger.log: "Fin du Boost - Retour au mode pr√©c√©dent"
      - script.execute: apply_fan_curve